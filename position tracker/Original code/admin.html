<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="p-4">
    <div class="container">
        <h1>Admin Dashboard</h1>

        <!-- -------------------- Login Form -------------------- -->
        {% if not session.user_id %}
        <div id="loginSection" class="mt-4">
            <h3>Admin Login</h3>
            {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
            {% endif %}
            <form method="POST" action="{{ url_for('admin_dashboard') }}">
                <div class="mb-3">
                    <label>Username</label>
                    <input type="text" name="username" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>Password</label>
                    <input type="password" name="password" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
        </div>
        {% endif %}

        <!-- -------------------- Admin Content -------------------- -->
        {% if session.user_id and session.role == 'admin' %}
        <div id="adminSection" class="mt-4">
            <button id="logoutBtn" class="btn btn-danger mb-3">Logout</button>

            <h3>Users</h3>
            <table class="table table-bordered" id="usersTable">
                <thead>
                    <tr><th>ID</th><th>Username</th><th>Role</th><th>Action</th></tr>
                </thead>
                <tbody></tbody>
            </table>

            <h5>Add User</h5>
            <form id="addUserForm" class="mb-3">
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="btn btn-success btn-sm">Add</button>
            </form>

            <h3>Devices</h3>
            <table class="table table-bordered" id="devicesTable">
                <thead>
                    <tr><th>ID</th><th>Device Name</th><th>User ID</th><th>Owner</th><th>Action</th></tr>
                </thead>
                <tbody></tbody>
            </table>

            <h5>Add Device</h5>
            <form id="addDeviceForm" class="mb-3">
                <input type="text" name="device_name" placeholder="Device Name" required>
                <input type="number" name="user_id" placeholder="User ID" required>
                <button type="submit" class="btn btn-success btn-sm">Add</button>
            </form>
        </div>
        {% endif %}
    </div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    {% if session.user_id and session.role == 'admin' %}
    // ------------------------- Load Admin Data -------------------------
    async function loadAdminData() {
        const resp = await fetch("/admin/data");
        const data = await resp.json();
        if(data.status !== "ok") return;

        // Users
        const usersBody = document.querySelector("#usersTable tbody");
        usersBody.innerHTML = "";
        data.users.forEach(u => {
            usersBody.innerHTML += `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.username}</td>
                    <td>${u.role}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id})">Delete</button></td>
                </tr>`;
        });

        // Devices
        const devicesBody = document.querySelector("#devicesTable tbody");
        devicesBody.innerHTML = "";
        data.devices.forEach(d => {
            devicesBody.innerHTML += `
                <tr>
                    <td>${d.id}</td>
                    <td>${d.device_name}</td>
                    <td>${d.user_id}</td>
                    <td>${d.owner}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteDevice(${d.id})">Delete</button></td>
                </tr>`;
        });
    }

    loadAdminData();

    // ------------------------- Add User -------------------------
    document.getElementById("addUserForm").addEventListener("submit", async e => {
        e.preventDefault();
        const formData = Object.fromEntries(new FormData(e.target).entries());
        await fetch("/admin/add_user", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(formData)
        });
        e.target.reset();
        loadAdminData();
    });

    // ------------------------- Add Device -------------------------
    document.getElementById("addDeviceForm").addEventListener("submit", async e => {
        e.preventDefault();
        const formData = Object.fromEntries(new FormData(e.target).entries());
        await fetch("/admin/add_device", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(formData)
        });
        e.target.reset();
        loadAdminData();
    });

    // ------------------------- Delete -------------------------
    window.deleteUser = async id => {
        await fetch(`/admin/delete_user/${id}`, { method: "DELETE" });
        loadAdminData();
    }
    window.deleteDevice = async id => {
        await fetch(`/admin/delete_device/${id}`, { method: "DELETE" });
        loadAdminData();
    }

    // ------------------------- Logout -------------------------
    document.getElementById("logoutBtn").addEventListener("click", async () => {
        await fetch("/logout");
        location.reload();
    });
    {% endif %}
});
</script>
</body>
</html>
